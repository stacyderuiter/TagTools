<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tag orientation: From tag frame to sperm whale frame • tagtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tag orientation: From tag frame to sperm whale frame">
<meta property="og:description" content="tagtools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tagtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/acceleration-filtering.html">Complementary filtering for acceleration: low- &amp; high-frequency</a>
    </li>
    <li>
      <a href="../articles/data-quality-error-correction.html">Data quality &amp; error correction</a>
    </li>
    <li>
      <a href="../articles/detectors-draft.html">detectors draft</a>
    </li>
    <li>
      <a href="../articles/Detectors.html">Detectors</a>
    </li>
    <li>
      <a href="../articles/dive-stats.html">Using dive_stats</a>
    </li>
    <li>
      <a href="../articles/find-dives.html">Using find_dives</a>
    </li>
    <li>
      <a href="../articles/fine-scale-tracking.html">Fine-scale tracking</a>
    </li>
    <li>
      <a href="../articles/install-load-tagtools.html">Installing and loading tagtools</a>
    </li>
    <li>
      <a href="../articles/jerk-transients.html">Jerk: a way to emphasize rapid changes in acceleration</a>
    </li>
    <li>
      <a href="../articles/load-tag-data.html">Load tag data</a>
    </li>
    <li>
      <a href="../articles/magnetometer-filtering.html">More complementary filtering: magnetometer &amp; dynamic acceleration</a>
    </li>
    <li>
      <a href="../articles/mahalanobis-distance.html">Mahalanobis distance</a>
    </li>
    <li>
      <a href="../articles/overview.html">Tagtools vignettes: overview and introduction</a>
    </li>
    <li>
      <a href="../articles/plots-and-cropping.html">Plots and cropping</a>
    </li>
    <li>
      <a href="../articles/rotation-test.html">Rotation test</a>
    </li>
    <li>
      <a href="../articles/tag-to-whale-frame.html">Tag orientation: From tag frame to sperm whale frame</a>
    </li>
    <li>
      <a href="../articles/vectors-vs-structures.html">Vectors and scalars versus structures</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tag-to-whale-frame_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tag orientation: From tag frame to sperm whale frame</h1>
                        <h4 class="author">tagtools project team</h4>
            
            <h4 class="date">2021-07-28</h4>
      
      
      <div class="hidden name"><code>tag-to-whale-frame.Rmd</code></div>

    </div>

    
    
<p>Welcome to the tag orientation vignette!</p>
<p>Thanks for taking some time to work with our package. We hope you’re having a great day!</p>
<p>This vignette deals with estimating and correcting the orientation of a tag on an animal. It will use tag data that are not aligned to the animal’s body axes, e.g., because the tag was applied to a free-moving whale. Your task will be to align the data to the animal’s body axes.</p>
<p>Additionally, be careful when copy-pasting special characters such as _underscores_ and ‘quotes’. If you get an error, one thing to check is that you have just a single, simple underscore, and <code>'straight quotes'</code>, whether <code>'single'</code> or <code>"double"</code> (rather than “smart quotes”).</p>
<p><em>Estimated time for this vignette: 25 minutes.</em></p>
<p>These practicals all assume that you have R/Rstudio installed on your machine, some basic experience working with them, and can execute provided code, making some user-specific changes along the way (e.g. to help R find a file you downloaded). We will provide you with quite a few lines. To boost your own learning, you would do well to try and write them before opening what we give, using this just to check your work.</p>
<div id="from-tag-frame-to-sperm-whale-frame" class="section level1">
<h1 class="hasAnchor">
<a href="#from-tag-frame-to-sperm-whale-frame" class="anchor"></a>From tag frame to sperm whale frame</h1>
<p>For tags placed on free-swimming animals, the tag axes will not generally coincide with the animal’s axes. The tag <code>A</code> and <code>M</code> data will therefore tell you how the tag, not the animal, is oriented. This can be corrected if you know the orientation of the tag on the animal, i.e., the pitch, roll and heading of the tag when the animal is horizontal and pointing north. Three steps are needed to do this: First the tag orientation on the whale is inferred by looking at accelerometer values when the animal is near the surface. The orientation may change if the tag moves or slides during a deployment and so we make an ‘orientation table’ that describes the sequence of orientations of the tag. This table is then used to convert tag frame measurements into animal frame.</p>
<div id="estimate-the-tag-orientations-on-the-whale" class="section level2">
<h2 class="hasAnchor">
<a href="#estimate-the-tag-orientations-on-the-whale" class="anchor"></a>Estimate the tag orientations on the whale</h2>
<p>Use <code><a href="../reference/load_nc.html">load_nc()</a></code> to read <code>testset5.nc</code>, which is from a pilot whale in the Canary Islands. Write it to the object <code>sw</code> to follow along with the code in this vignette. This dataset is built into the <code>tagtools</code> package, so you can access it using <code>system.file</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tagtools</span><span class="op">)</span>
<span class="va">sw_file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"testset5.nc"</span>, package <span class="op">=</span> <span class="st">"tagtools"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">sw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_nc.html">load_nc</a></span><span class="op">(</span><span class="va">sw_file_path</span><span class="op">)</span></code></pre></div>
<p>We will use <code><a href="../reference/prh_predictor1.html">prh_predictor1()</a></code> to infer the tag-to-animal orientation. This function is for animals like pilot whales that log (more or less) at the surface before diving steeply. It assumes two things:</p>
<ul>
<li>that the animal rests horizontally at the surface (at least on average).</li>
<li>that it dives steeply away from the surface without rolling, at least initially.</li>
</ul>
<p>If these are not good assumptions for your animal, <code><a href="../reference/prh_predictor2.html">prh_predictor2()</a></code> may work. It is suitable for whales such as beaked whales that make short dives between breaths at the surface. Both tools try to predict the tag orientation on the whale parameterized by its pitch, roll and yaw (which we shall call <code>p0</code>, <code>r0</code>, and <code>h0</code>). To use <code><a href="../reference/prh_predictor1.html">prh_predictor1()</a></code>, we need to define a minimum dive depth to analyse—let’s say 400 m. Then call the tool like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PRH</span> <span class="op">=</span> <span class="fu"><a href="../reference/prh_predictor1.html">prh_predictor1</a></span><span class="op">(</span><span class="va">sw</span><span class="op">$</span><span class="va">P</span>, <span class="va">sw</span><span class="op">$</span><span class="va">A</span>, TH <span class="op">=</span> <span class="fl">400</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#PRH1"> Show/Hide Results </button>  
<div id="PRH1" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
PRH = prh_predictor1(sw$P, sw$A, TH = 400)
```

</div>
-->
<p>A graphical interface will open showing the dive profile (top), the estimated tag-to-animal orientations throughout the deployment (middle panel), and the quality of these estimates (bottom panel). In the middle panel, the colored stars show the <code>p0</code>, <code>r0</code> and <code>h0</code> estimates at the start of each dive.</p>
<!-- Sam here again: recall that this GUI really doesn't work on Mac. Please fix when you get a chance! :) ALSO...

Once it IS fixed, then you can go through and remove the rest of these HTML comment-outings, and the code-folding example outputs should work. That is, assuming that the code is good. I don't exactly have a way to test it, since the GUI that generates the data isn't working for me.

-->
<p>A quality measure of &lt;0.05 in the bottom panel indicates that the data fit well with the assumptions of the method.</p>
<p>If the tag does not move on the animal from dive to dive, then <code>p0</code>, <code>r0</code> and <code>h0</code> should be fairly constant across dives. If they are not constant it can be due to a sudden change (e.g., the tag gets hit) or a slow movement of the tag on the animal. In this case it seems that there is a change in orientation between dives 6 and 7.</p>
<p>The function automatically picks segments of data to analyse, and you should check that it did this well, especially if the ‘quality’ number is &gt; 0.05. The third dive has a slightly bad quality: type <code>e</code> on the main figure to “edit” and then click on one of the third dive orientation points. <em>Note that prompts will appear at the very top of the figure window(s), which will update based on the most recent user actions.</em></p>
<p>A new plot will be drawn in the second figure window (pull it up if it does not automatically come to the front) in which the top panel shows the acceleration data in the tag frame for the current dive edge. Blue, orange or red (depending on your Matlab/Octave version) and yellow represent the x, y and z axes, respectively.</p>
<p>The bottom panel shows the acceleration data after correction using the <code>p0</code>, <code>r0</code> and <code>h0</code> estimates printed above the panel.</p>
<p>Two black rectangles show the data segments that have been chosen for analysis and these may need to be moved:</p>
<ul>
<li>The left-hand or ‘surface’ segment should be positioned just before the start of the dive.</li>
<li>The right-hand or ‘dive’ segment should be just after the start of the dive.</li>
<li>The surface segment should cover an interval of consistent surfacing behaviour (either logging or shallow diving).</li>
<li>The dive segment should contain only roll-free steep diving, i.e., the blue and red lines (the x- and y-axes) should be close to -9.8 m/s2 and 0, respectively, in the lower panel.</li>
</ul>
<p>The segment edges are numbered 1 to 4 from the left. To change a segment, hover the mouse over the plot and type the relevant number, then click the mouse where you want the newly-drawn box edge to be. The segment will move and the <code>p0</code>, <code>r0</code>, <code>h0</code> and quality will be re-calculated. When you are satisfied with the estimate quality, type q and then return to the first figure.</p>
</div>
<div id="produce-the-orientation-table" class="section level2">
<h2 class="hasAnchor">
<a href="#produce-the-orientation-table" class="anchor"></a>Produce the orientation table</h2>
<p>We need to create an orientation table (OTAB) that summarizes the tag orientation on the animal as a function of time. Each row of the OTAB matrix describes the orientation of the tag on the animal over a time interval. If there are two moves, the OTAB will have three lines: the initial orientation and the orientation after each move.</p>
<p>Each row defines how the tag is oriented on the animal and has columns: <code>t1</code>, <code>t2</code>, <code>p0</code>, <code>r0</code>, <code>h0</code>. <code>t1</code> and <code>t2</code> are the start and end times of the move (in seconds-since-tag-on), and <code>p0</code>, <code>r0</code>, <code>h0</code> are the new orientation Euler angles after the move (in radians).</p>
<p>The initial orientation (i.e., the first row in the OTAB) always has <code>t1</code> = <code>t2</code> = 0. For subsequent moves, if the move is instantaneous, use <code>t2</code> = <code>t1</code>. If the move is gradual, set <code>t1</code> to the time at which the movement appears to start and set <code>t2</code> to the time when the move appears to be complete.</p>
<p>Making the OTAB is a bit of a black art. <code><a href="../reference/prh_predictor1.html">prh_predictor1()</a></code> is not infinitely precise, and an apparent change of less than 10 degrees is probably not worth worrying about.</p>
<p>We are going to assume there is just one move (i.e., during the 6th dive) in our pilot whale data. Position the mouse over the blue (<code>p0</code>), red or orange (<code>r0</code>), and yellow (<code>h0</code>) lines before the move and click the left button on each to get the angle (in degrees). Make the first OTAB line:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">otab1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p0</span>, <span class="va">r0</span> , <span class="va">h0</span><span class="op">)</span><span class="op">*</span><span class="va">pi</span><span class="op">/</span><span class="fl">180</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#otab1"> Show/Hide Results </button>  
<div id="otab1" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
otab1 <- matrix(data = c(0,0, c(p0, r0 , h0)*pi/180), nrow = 1)
```

</div>
-->
<p>where <code>p0</code>, <code>r0</code> and <code>h0</code> are your readings. The pi/180 converts these into radians.</p>
<p>For the second OTAB line, read off the <code>p0</code>, <code>r0</code> and <code>h0</code> values after the move and decide when the move actually happens (let’s say it is a sudden move at the end of the dive, e.g., at 10100 seconds). Then:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">otab2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10100</span>, <span class="fl">10100</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p0</span>, <span class="va">r0</span>, <span class="va">h0</span><span class="op">)</span><span class="op">*</span><span class="va">pi</span><span class="op">/</span><span class="fl">180</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#otab2"> Show/Hide Results </button>  
<div id="otab2" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
otab2 <- matrix(data = c(10100, 10100, c(p0, r0, h0)*pi/180), nrow = 1)
```

</div>
-->
<p>Finally, type ‘q’ to quit prh_predictor1. Now you can make the OTAB matrix:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">OTAB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">otab1</span>, 
              <span class="va">otab2</span><span class="op">)</span></code></pre></div>
<!-- 
<button class="btn btn-primary" data-toggle="collapse" data-target="#OTAB_rbind"> Show/Hide Results </button>  
<div id="OTAB_rbind" class="collapse"> -->
<!--```{r, echo = FALSE, eval = TRUE}
OTAB <- rbind(otab1, 
              otab2)
```

</div>
-->
</div>
<div id="tag-frame-to-animal-frame" class="section level2">
<h2 class="hasAnchor">
<a href="#tag-frame-to-animal-frame" class="anchor"></a>Tag frame to animal frame</h2>
<p>Use your OTAB to convert tag frame measurements (<code>A</code> or <code>M</code>) to animal frame:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Aa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tag2animal.html">tag2animal</a></span><span class="op">(</span><span class="va">sw</span><span class="op">$</span><span class="va">A</span>, OTAB <span class="op">=</span> <span class="va">OTAB</span><span class="op">)</span> </code></pre></div>
<!-- don't need code folding on little ones like these. HOWEVER, they should be set to `eval = TRUE` once the GUI works. -->
<p>For this particular dataset, only <code>A</code> is provided, but in case you want to also convert tag frame magnetometer measurements to animal frame, you could do so in a similar way, using code of the form:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Ma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tag2animal.html">tag2animal</a></span><span class="op">(</span><span class="va">sw</span><span class="op">$</span><span class="va">M</span>, OTAB <span class="op">=</span> <span class="va">OTAB</span><span class="op">)</span></code></pre></div>
<p><code>Aa</code> should now contain acceleration data like what would have been recorded by a tag aligned with the animal’s axes, <em>i.e.</em>, in the animal frame. Compute pitch and roll from <code>Aa</code> and plot them to check they make sense:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/a2pr.html">a2pr</a></span><span class="op">(</span><span class="va">Aa</span><span class="op">)</span>
<span class="va">pitch</span> <span class="op">&lt;-</span> <span class="va">pr</span><span class="op">$</span><span class="va">p</span>
<span class="va">roll</span> <span class="op">&lt;-</span> <span class="va">pr</span><span class="op">$</span><span class="va">r</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">pr</span><span class="op">)</span>

<span class="fu"><a href="../reference/plott.html">plott</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>depth <span class="op">=</span> <span class="va">P</span>, pitch <span class="op">=</span> <span class="va">pitch</span><span class="op">*</span><span class="fl">180</span><span class="op">/</span><span class="va">pi</span>, roll <span class="op">=</span> <span class="va">roll</span><span class="op">*</span><span class="fl">180</span><span class="op">/</span><span class="va">pi</span><span class="op">)</span>,
      fsx <span class="op">=</span> <span class="va">Aa.sampling_rate</span>, interactive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#plott_pr"> Show/Hide Results </button>  
<div id="plott_pr" class="collapse"> -->
<!--```{r, echo = FALSE, eval = TRUE}
pr <- a2pr(Aa)
pitch <- pr$p
roll <- pr$r
rm(pr)

plott(X = list(depth = P, pitch = pitch*180/pi, roll = roll*180/pi),
      fsx = Aa.sampling_rate, interactive = TRUE)
```

</div>
-->
<p>The <code>pitch</code> and <code>roll</code> vectors are in radians (hence the *180/pi to covert to degrees) and have the same sampling rate as <code>Aa</code>. Zoom in to check if the animal is in a realistic orientation when it is at the surface, or during an ascent or descent.</p>
<p>When you are comfortable that the tag is well aligned to the animal frame, you can add the corrected data to the archive file:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/add_nc.html">add_nc</a></span><span class="op">(</span><span class="st">'testset5_animal_frame'</span>, <span class="va">Aa</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#save_nc_animal_frame"> Show/Hide Results </button>  
<div id="save_nc_animal_frame" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
add_nc('testset5_animal_frame', Aa)
```

</div>
-->
<p>There is no need to also save <code>pitch</code> and <code>roll</code> because these can be easily re-computed from <code>Aa</code>. The archive file should only contain source data or data that has been corrected. The orientation correction steps and the <code>OTAB</code> are stored in <code>Aa</code>, and so this information is saved automatically in your archive file. Nice work!</p>
<div id="extra-quality-check" class="section level3">
<h3 class="hasAnchor">
<a href="#extra-quality-check" class="anchor"></a>Extra quality check</h3>
<p>If you have time and want something extra, do the following check.</p>
<p>The code below will compute the smoothed pitch angle; 12 is the smoothing parameter. Signal components above 1/12 of the Nyquist frequency are filtered out.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pitch_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/a2pr.html">a2pr</a></span><span class="op">(</span><span class="fu">tagtools</span><span class="fu">::</span><span class="fu"><a href="../reference/smooth.html">smooth</a></span><span class="op">(</span><span class="va">Aa.data</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!--
<button class="btn btn-primary" data-toggle="collapse" data-target="#pitch_s"> Show/Hide Results </button>  
<div id="pitch_s" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
pitch_s <- a2pr(tagtools::smooth(Aa.data, 12))
```

</div>
-->
<p>Now find the whale’s vertical speed in m/sec:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/depth_rate.html">depth_rate</a></span><span class="op">(</span><span class="va">sw</span><span class="op">$</span><span class="va">P</span><span class="op">)</span>        </code></pre></div>
<p>And plot it. Feel free to convert to your favorite graphics system - I love <a href="https://cran.r-project.org/web/packages/ggformula/vignettes/ggformula-blog.html">ggformula</a>…</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">pitch_s</span><span class="op">*</span><span class="fl">180</span><span class="op">/</span><span class="va">pi</span>, type <span class="op">=</span> <span class="st">'p'</span>, pch <span class="op">=</span> <span class="fl">16</span>,
     ylab <span class="op">=</span> <span class="st">'smooth pitch (degrees)'</span>,
     xlab <span class="op">=</span> <span class="st">'speed (m/sec)'</span><span class="op">)</span>   </code></pre></div>
<!--

<button class="btn btn-primary" data-toggle="collapse" data-target="#plot_v"> Show/Hide Results </button>  
<div id="plot_v" class="collapse"> -->
<!--```{r, eval = TRUE, echo = FALSE}
plot(v, pitch_s*180/pi, type = 'p', pch = 16,
     ylab = 'smooth pitch (degrees)',
     xlab = 'speed (m/sec)')   
```

</div>
-->
<p>If <code>Aa</code> is done right, there should be a fairly good negative correlation between depth rate and pitch. There will be some outliers because we didn’t put the tag orientation change in <em>quite</em> the right place. If you feel like making some fine adjustments, improve your OTAB and perform this check again. With your own data, you will likely spend <em>a lot</em> of time making these small adjustments.</p>
</div>
</div>
</div>
<div id="review" class="section level1">
<h1 class="hasAnchor">
<a href="#review" class="anchor"></a>Review</h1>
<p>You’ve learned how to estimate tag orientation over time, as well as how to correct for it when these estimates are problematic.</p>
<p>Congrats! You made it through this vignette.</p>
<p><em>If you’d like to continue working through these vignettes, consider <code>acceleration-filtering</code>. In it, you’ll look at acceleration data, and consider quick changes in acceleration (high-frequency acceleration) versus slower changes (low-frequency acceleration) to interpret an animal’s behavior.</em></p>
<hr>
<p>Animaltags home pages: <a href="http://animaltags.org/" class="uri">http://animaltags.org/</a> (old), <a href="https://animaltags.netlify.app/" class="uri">https://animaltags.netlify.app/</a> (new), <a href="https://github.com/stacyderuiter/TagTools" class="uri">https://github.com/stacyderuiter/TagTools</a> (for source code)</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Stacy DeRuiter.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
